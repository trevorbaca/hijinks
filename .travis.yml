version: ~> 1.0

os: linux

dist: xenial

language: python

python:
    - 3.7
    - 3.8

before_install:
    # define variables
    - name=hijinks
    - contents=$TRAVIS_BUILD_DIR/$name

    # install lilypond:
    - LILYPOND=/tmp/lilypond
    - LILYPOND_URL=http://lilypond.org/download/binaries/linux-64/
    - LILYPOND_SOURCE=lilypond-2.19.84-1.linux-64.sh
    - wget -q -O $LILYPOND $LILYPOND_URL/$LILYPOND_SOURCE
    - sh $LILYPOND --batch

    # clone & install abjad dev branch:
    - ABJAD=/tmp/abjad
    - git clone -b trevor/dev https://github.com/Abjad/abjad.git $ABJAD
    - pip install $ABJAD
    - export MYPYPATH=$ABJAD

    # clone & install rmakers:
    - RMAKERS=/tmp/abjad-ext-rmakers
    - git clone https://github.com/Abjad/abjad-ext-rmakers.git $RMAKERS
    - pip install $RMAKERS
    - export MYPYPATH=$MYPYPATH:$RMAKERS

    # clone & install baca:
    - BACA=/tmp/baca
    - git clone https://github.com/trevorbaca/baca.git $BACA
    - pip install $BACA
    - export MYPYPATH=$MYPYPATH:$BACA

    # symlink to mypy configfile
    - ln -s $BACA/dotfiles/mypy.ini ~/.mypy.ini

    # clone & install baca test:
    - TEST=/tmp/test
    - git clone https://github.com/trevorbaca/test.git $TEST
    
    # symlink to baca test
    - unlink $contents/test.py
    - ln -s $TEST/test_segments.py $contents/test.py

    # clone & install ide:
    - IDE=/tmp/ide
    - git clone https://github.com/Abjad/ide.git $IDE
    - pip install $IDE
    - export MYPYPATH=$MYPYPATH:$IDE
    - export PATH=$PATH:$IDE/ide/scr

    # log environment variables
    - echo $MYPYPATH
    - echo $PATH
    - echo $PYTHONPATH
    - echo $TRAVIS_BUILD_DIR

    # log present working directory
    - pwd
    - ls

install:
    - pip install -e .
    - prime-parser-tables

    # log versions
    - black --version
    - flake8 --version
    - isort --version
    - mypy --version
    - pytest --version

script:
    - $BACA/scr/black-check $contents
    - $BACA/scr/flake8-check $contents
    - $BACA/scr/isort-check $contents
    - mypy $contents
    - $BACA/scr/baca-doctest $contents
    - py.test -rf $contents/test.py

notifications:
    email: false
